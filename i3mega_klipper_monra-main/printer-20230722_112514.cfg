[include probe.cfg]
[include macros.cfg]
[include Display.cfg]
[include runoutsensor.cfg]
[include bambu_studio.cfg]
[include variables.cfg]
[display_status]
[respond]



[stepper_x]
step_pin: PF0
dir_pin: PF1
enable_pin: !PD7
rotation_distance: 39.78
microsteps: 16
endstop_pin: ^!PE5
position_min: -3
position_endstop: -2
position_max: 225
homing_speed: 30.0

[stepper_y]
step_pin: PF6
dir_pin: !PF7
enable_pin: !PF2
rotation_distance: 39.92
microsteps: 16
endstop_pin: ^!PJ1
position_min: -8
position_endstop: -6
position_max: 225
homing_speed: 30.0

[stepper_z]
step_pin: PL3
dir_pin: !PL1
enable_pin: !PK0
rotation_distance: 8
microsteps: 16
#endstop_pin: ^!PD3
endstop_pin: probe:z_virtual_endstop
#position_endstop: 0.0
position_max: 199
homing_speed: 5.0
position_min: -2

[stepper_z1]
step_pin: PC1
dir_pin: !PC3
enable_pin: !PC7
microsteps: 16
rotation_distance: 8
#endstop_pin: ^!PL6

[safe_z_home]
home_xy_position: 110, 110
speed: 50
z_hop: 2
z_hop_speed: 3

[extruder]
step_pin: PA4
dir_pin: PA6
enable_pin: !PA2
#rotation_distance: 34.5
rotation_distance: 7.8021405
microsteps: 16
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PB4
max_extrude_only_distance: 90.0
max_extrude_cross_section: 5
# Longitud màxima (en mm de filament cru) que pot tenir una retracció.
# moviment només extrusió. Si un moviment de retracció o extrusió només
# sol·licita una distància superior a aquest valor, provocarà un error
# per tornar. El valor predeterminat és de 50 mm.
#sensor_type: ATC Semitec 104GT-2
sensor_type: Generic 3950    #Anycubic v5 default
sensor_pin: PK5
#control: pid
# pid_kp = 20.422
# pid_ki = 0.752
# pid_kd = 138.618
min_temp: 0
max_temp: 280
pressure_advance: 0.0464 

#Comprobación de la temperatura antes de error
[verify_heater extruder]
max_error: 190
hysteresis: 12

[temperature_sensor raspberry_pi]
sensor_type: temperature_host

[input_shaper]
shaper_freq_x: 47.6
shaper_freq_y: 46.2

[save_variables]
filename: ~/variables.cfg

##############################################################################
##############################################################################
# Activa l'exclusió d'objectes
[exclude_object]

[gcode_macro M486]
gcode:
  # Parameters known to M486 are as follows:
  #   [C<flag>] Cancel the current object
  #   [P<index>] Cancel the object with the given index
  #   [S<index>] Set the index of the current object.
  #       If the object with the given index has been canceled, this will cause
  #       the firmware to skip to the next object. The value -1 is used to
  #       indicate something that isn’t an object and shouldn’t be skipped.
  #   [T<count>] Reset the state and set the number of objects
  #   [U<index>] Un-cancel the object with the given index. This command will be
  #       ignored if the object has already been skipped

  {% if 'exclude_object' not in printer %}
    {action_raise_error("[exclude_object] is not enabled")}
  {% endif %}

  {% if 'T' in params %}
    EXCLUDE_OBJECT RESET=1

    {% for i in range(params.T | int) %}
      EXCLUDE_OBJECT_DEFINE NAME={i}
    {% endfor %}
  {% endif %}

  {% if 'C' in params %}
    EXCLUDE_OBJECT CURRENT=1
  {% endif %}

  {% if 'P' in params %}
    EXCLUDE_OBJECT NAME={params.P}
  {% endif %}

  {% if 'S' in params %}
    {% if params.S == '-1' %}
      {% if printer.exclude_object.current_object %}
        EXCLUDE_OBJECT_END NAME={printer.exclude_object.current_object}
      {% endif %}
    {% else %}
      EXCLUDE_OBJECT_START NAME={params.S}
    {% endif %}
  {% endif %}

  {% if 'U' in params %}
    EXCLUDE_OBJECT RESET=1 NAME={params.U}
  {% endif %}

###############################################################################################
###############################################################################################

[heater_fan extruder_fan]
pin: PH6
heater: extruder
heater_temp: 50

[controller_fan stepstick_fan]
pin: PH4
stepper: stepper_z, stepper_y, stepper_x, stepper_z1, extruder

[heater_bed]
heater_pin: PH5
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PK6
#control: pid
#pid_Kp: 75.233 
#pid_Ki: 1.203 
#pid_Kd: 1176.453
min_temp: 0
max_temp: 110

[bed_mesh]
speed: 100
horizontal_move_z: 5
mesh_min: 15,15
mesh_max: 200, 200
probe_count: 5, 5
fade_end: 150
split_delta_z: 0.01
move_check_distance: 3
mesh_pps: 2, 2
algorithm: lagrange
relative_reference_index: 4




[fan]
pin: PL5

[mcu]
serial: /dev/serial/by-id/usb-Silicon_Labs_CP2102_USB_to_UART_Bridge_Controller_0001-if00-port0

[printer]
kinematics: cartesian
max_velocity: 200
max_accel: 3000
max_z_velocity: 10
max_z_accel: 60

[idle_timeout]
timeout: 1200


     
[virtual_sdcard]
path: ~/printer_data/gcodes

[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345]
cs_pin: rpi:None

[input_shaper]
shaper_freq_x: 49.6
shaper_type_x: 3hump_ei
shaper_freq_y: 40.2
shaper_type_y: 2hump_ei

[resonance_tester]
accel_chip: adxl345
probe_points:
    100,100,20  # an example


[respond]
[pause_resume]

[gcode_arcs]
resolution: 0.2 
#   An arc will be split into segments. Each segment's length will
#   equal the resolution in mm set above. Lower values will produce a
#   finer arc, but also more work for your machine. Arcs smaller than
#   the configured value will become straight lines. The default is
#   1mm.

[gcode_arcs]
resolution: 0.1

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 0.750
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 19.997
#*# pid_ki = 0.745
#*# pid_kd = 134.233
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 73.853
#*# pid_ki = 1.061
#*# pid_kd = 1285.048
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.010000, -0.005000, 0.000000, -0.005000, 0.000000
#*# 	0.020000, 0.070000, 0.080000, 0.075000, 0.005000
#*# 	0.025000, 0.125000, 0.170000, 0.140000, 0.080000
#*# 	0.060000, 0.190000, 0.250000, 0.250000, 0.135000
#*# 	0.130000, 0.290000, 0.345000, 0.390000, 0.310000
#*# tension = 0.2
#*# min_x = 15.0
#*# algo = lagrange
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = 15.0
#*# x_count = 5
#*# max_y = 199.99
#*# mesh_x_pps = 2
#*# max_x = 200.0
#*#
#*# [bed_mesh malla]
#*# version = 1
#*# points =
#*# 	-0.082875, 0.137109, 0.028641
#*# 	-0.233391, 0.000000, -0.186469
#*# 	-0.198656, -0.138328, -0.251672
#*# tension = 0.2
#*# min_x = 15.0
#*# algo = lagrange
#*# y_count = 3
#*# mesh_y_pps = 2
#*# min_y = 15.0
#*# x_count = 3
#*# max_y = 200.0
#*# mesh_x_pps = 2
#*# max_x = 200.0
